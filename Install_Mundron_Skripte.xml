<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE MudletPackage>
<MudletPackage version="1.001">
	<TriggerPackage />
	<TimerPackage>
		<Timer isActive="no" isFolder="no" isTempTimer="no" isOffsetTimer="no">
			<name>test_install_status</name>
			<script>if MundronInstaller and MundronInstaller.done then
  disableTimer("test_install_status")
else
  disableTimer("test_install_status")
end</script>
			<command></command>
			<packageName></packageName>
			<time>00:00:01.000</time>
		</Timer>
		<Timer isActive="yes" isFolder="no" isTempTimer="no" isOffsetTimer="no">
			<name>error_display</name>
			<script>local function centralize(text, space)
  if string.fill ~= nil then
    return string.fill(text, space)
  else
    return text
  end
end

if MundronInstaller and MundronInstaller.errors and #MundronInstaller.errors &gt; 0 then
  print("&lt;255,155,0:0,0,0&gt;" .. centralize("Es wurden folgende Fehler identifiziert", "="))
  for i, err in ipairs(MundronInstaller.errors) do
    print("&lt;255,155,0:0,0,0&gt;"..centralize(f"Fehler {i}", "-"))
    print(f"{err}\n")
  end
  print("&lt;255,155,0:0,0,0&gt;"..centralize("Die Fehlermeldungen werden nach einer Minute wiederholt", "="))
  print("&lt;255,155,0:0,0,0&gt;"..centralize("Bitte Fehler beheben und Profile neu starten", "="))
end</script>
			<command></command>
			<packageName></packageName>
			<time>00:01:00.000</time>
		</Timer>
	</TimerPackage>
	<AliasPackage />
	<ActionPackage />
	<ScriptPackage>
		<Script isActive="yes" isFolder="no">
			<name>Core (Installer)</name>
			<packageName></packageName>
			<script>MundronInstaller = MundronInstaller or {
  prio = {
    ["Mundron_Core"]=-1,
    ["GUI"]=2,
    ["Wegeskript"]=2
  },
  installed={},
  errors = {},
  loaded = true
}</script>
			<eventHandlerList />
		</Script>
		<Script isActive="yes" isFolder="no">
			<name>install_Mundron_modules</name>
			<packageName></packageName>
			<script>local function iprint(text)
  print(f"&lt;120,170,255:0,0,0&gt;{text}")
end

local function get_repo_path()
  local path_table = string.split(getModulePath("Install_Mundron_Skripte"), "/")
  return table.concat(path_table, "/", 1, #path_table - 1)
end

function check_for_new_modules(_, path)
  for entry in lfs.dir(path) do
    if entry:find(".xml") then
      local name = entry:gsub(".xml", "")
      if not MundronInstaller.installed[name] then
        -- install new module 
        iprint(f"Install module {path}/{entry}")
        installModule(f"{path}/{entry}")
        if MundronInstaller.prio[name] then
          iprint(f"Set priority to {MundronInstaller.prio[name]}")
          setModulePriority(name, MundronInstaller.prio[name])
        end
        enableModuleSync(name)
        MundronInstaller.installed[name] = true
      end
    end
  end
end

function install_Mundron_modules()
  if MundronInstaller.loaded then
    return
  end
  iprint("Check which modules are already installed", "Installer")
  for _, name in ipairs(getModules()) do
    MundronInstaller.installed[name] = true
    print(f"Found module {name}")
  end
  iprint("Check repository for modules")
  local repo = get_repo_path()
  iprint(f"Search in {repo}")
  for entry in lfs.dir(repo) do
    if entry:find("module") then
      local subdir = f"{repo}/{entry}"
      iprint(f"Search for modules in {subdir}")
      check_for_new_modules(nil, subdir)
      addFileWatch(subdir)
    end
  end
  registerAnonymousEventHandler("sysPathChanged", "check_for_new_modules")
  MundronInstaller.loaded = true
end


function add_error(msg)
  table.insert(MundronInstaller.errors, msg)
end</script>
			<eventHandlerList>
				<string>sysInstallModule</string>
			</eventHandlerList>
		</Script>
	</ScriptPackage>
	<KeyPackage />
	<HelpPackage>
		<helpURL></helpURL>
	</HelpPackage>
</MudletPackage>
